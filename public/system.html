<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System - DUHIGURE MU MIRYANGO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #006633;
            --secondary: #00a651;
            --accent: #fad201;
        }
        .navbar { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)) !important; 
        }
        .btn-primary { background-color: var(--secondary); border: none; }
        .btn-primary:hover { background-color: var(--primary); }
        .btn-success { background-color: var(--secondary); }
        .btn-info { background-color: #007bff; }
        .btn-warning { background-color: var(--accent); color: #000; }

        .card { 
            border-radius: 20px; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.12); 
            border: none; 
            overflow: hidden;
        }
        .card-header { 
            background: linear-gradient(135deg, var(--secondary), var(--primary)); 
            color: white; 
            border-radius: 20px 20px 0 0 !important; 
            font-weight: bold;
        }
        .action-btn { 
            height: 140px; 
            border-radius: 20px; 
            font-size: 1.2rem; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            transition: all 0.4s;
        }
        .action-btn i { font-size: 2.5rem; margin-bottom: 10px; }
        .action-btn:hover { 
            transform: scale(1.08); 
            box-shadow: 0 12px 30px rgba(0,102,51,0.3); 
        }

        .member-card { 
            border-radius: 15px; 
            border-left: 6px solid var(--secondary); 
            transition: all 0.3s;
        }
        .member-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.18); 
        }

        .modal-header { 
            background: linear-gradient(135deg, var(--secondary), var(--primary)); 
            color: white; 
            border-radius: 15px 15px 0 0;
        }
        .stats-card { 
            background: linear-gradient(135deg, #26d0ce, #1a2980); 
            color: white; 
            border-radius: 20px; 
            transition: transform 0.3s;
        }
        .stats-card:hover { transform: translateY(-8px); }

        .badge-custom { 
            padding: 10px 18px; 
            border-radius: 30px; 
            background: var(--accent); 
            color: #000; 
            font-weight: bold;
        }
        .toast-container { position: fixed; top: 80px; right: 20px; z-index: 9999; }

        body { background: #f5f9f5; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="index.html">
                <i class="fas fa-users me-2"></i>DUHIGURE MU MIRYANGO
            </a>
            <button class="btn btn-light btn-sm" onclick="loadStats()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
        </div>
    </nav>

    <div class="toast-container"></div>

    <section class="py-5 mt-4">
        <div class="container">
            <h2 class="mb-5 text-center fw-bold text-success">
                <i class="fas fa-home me-2"></i>Family Management Dashboard
            </h2>

            <!-- Stats Cards -->
            <div class="row mb-5 g-4">
                <div class="col-md-4">
                    <div class="card stats-card p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 opacity-75">Total Families</h6>
                                <h2 class="mb-0 mt-2" id="totalFamilies">0</h2>
                            </div>
                            <i class="fas fa-home fa-4x opacity-30"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stats-card p-4" style="background: linear-gradient(135deg, #ff9a9e, #fad0c4);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 opacity-75">Total Members</h6>
                                <h2 class="mb-0 mt-2" id="totalMembers">0</h2>
                            </div>
                            <i class="fas fa-users fa-4x opacity-30"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stats-card p-4" style="background: linear-gradient(135deg, #a8edea, #fed6e3);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0 opacity-75">Active Duties</h6>
                                <h2 class="mb-0 mt-2" id="totalDuties">0</h2>
                            </div>
                            <i class="fas fa-tasks fa-4x opacity-30"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons (fixed with data-bs-*) -->
            <div class="row mb-5 g-4 text-center">
                <div class="col-md-3">
                    <button class="btn btn-primary action-btn w-100 shadow-lg" 
                            data-bs-toggle="modal" data-bs-target="#familyModal">
                        <i class="fas fa-home"></i>
                        Register Family
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-success action-btn w-100 shadow-lg" 
                            data-bs-toggle="modal" data-bs-target="#memberModal">
                        <i class="fas fa-user-plus"></i>
                        Add Member
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-info action-btn w-100 shadow-lg text-white" 
                            data-bs-toggle="modal" data-bs-target="#dutyModal">
                        <i class="fas fa-clipboard-list"></i>
                        Assign Duty
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-warning action-btn w-100 shadow-lg" 
                            data-bs-toggle="modal" data-bs-target="#viewModal">
                        <i class="fas fa-eye"></i>
                        View All
                    </button>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Recent Members</h5>
                        </div>
                        <div class="card-body" id="recentMembersContainer">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                <p class="mt-2">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>Performance Duties</h5>
                        </div>
                        <div class="card-body" id="dutiesListContainer">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                <p class="mt-2">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- All Modals (copy from your original code) -->
    <!-- Family Modal -->
    <div class="modal fade" id="familyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-home me-2"></i>Register New Family</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="familyForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Family Name</label>
                            <input type="text" class="form-control form-control-lg" name="family_name" placeholder="Enter family name" required pattern="[A-Za-z\\s]+" title="Name should contain only letters and spaces">
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-check me-2"></i>Register Family
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Member Modal -->
    <div class="modal fade" id="memberModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Add Family Member</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="memberForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Select Family</label>
                                <select class="form-select" id="familySelect" name="family_id" required>
                                    <option value="">Choose a family...</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Full Name</label>
                                <input type="text" class="form-control" name="name" placeholder="Enter full name" required pattern="[A-Za-z\\s]+" title="Name should contain only letters and spaces">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Email Address</label>
                                <input type="email" class="form-control" name="email" placeholder="email@example.com" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Phone Number</label>
                                <input type="tel" class="form-control" name="phone" placeholder="+250 xxx xxx xxx"  title="Phone must be in +250xxxxxxxxx format">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Relationship</label>
                            <select class="form-select" name="relationship" required>
                                <option value="">Select relationship...</option>
                                <option value="Father">Father</option>
                                <option value="Mother">Mother</option>
                                <option value="Son">Son</option>
                                <option value="Daughter">Daughter</option>
                                <option value="Brother">Brother</option>
                                <option value="Sister">Sister</option>
                                <option value="Grandfather">Grandfather</option>
                                <option value="Grandmother">Grandmother</option>
                                <option value="Uncle">Uncle</option>
                                <option value="Aunt">Aunt</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-user-check me-2"></i>Add Member
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Duty Modal -->
    <div class="modal fade" id="dutyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-clipboard-list me-2"></i>Assign Performance Duty</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="dutyForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Select Family</label>
                            <select class="form-select" id="dutyFamilySelect" name="family_id" required>
                                <option value="">Choose a family...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Assign To (Optional)</label>
                            <select class="form-select" id="dutyMemberSelect" name="member_id">
                                <option value="">Entire Family</option>
                            </select>
                            <small class="text-muted">Leave blank to assign to entire family</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Duty Description</label>
                            <textarea class="form-control" name="duty" rows="3" placeholder="Describe the duty..." required minlength="10"></textarea>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-info btn-lg">
                                <i class="fas fa-tasks me-2"></i>Assign Duty
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- View All Modal -->
    <div class="modal fade" id="viewModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-list me-2"></i>All Family Members</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Filter by Family</label>
                            <select class="form-select" id="viewFamilySelect">
                                <option value="">All Families</option>
                            </select>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="loadAllMembers()">
                                <i class="fas fa-sync-alt me-2"></i>Refresh List
                            </button>
                        </div>
                    </div>
                    <div id="allMembersContainer">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Member Details Modal -->
    <div class="modal fade" id="memberDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user me-2"></i>Member Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="memberDetailsContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="deleteMemberBtn">
                        <i class="fas fa-trash me-2"></i>Delete Member
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Your full original script here (no changes)
        let currentMemberId = null;

        function getFromStorage(key, defaultValue = []) {
            return JSON.parse(localStorage.getItem(key)) || defaultValue;
        }
        function setToStorage(key, value) {
            localStorage.setItem(key, JSON.stringify(value));
        }

        if (!localStorage.getItem('families')) {
            const sampleFamilies = [{ id: 1, family_name: 'Sample Family 1' }, { id: 2, family_name: 'Sample Family 2' }];
            setToStorage('families', sampleFamilies);
        }
        if (!localStorage.getItem('members')) {
            const sampleMembers = [
                { id: 1, family_id: 1, name: 'John Doe', email: 'john@example.com', phone: '+250123456789', relationship: 'Father' },
                { id: 2, family_id: 1, name: 'Jane Doe', email: 'jane@example.com', phone: '+250987654321', relationship: 'Mother' }
            ];
            setToStorage('members', sampleMembers);
        }
        if (!localStorage.getItem('duties')) {
            const sampleDuties = [
                { id: 1, family_id: 1, member_id: null, duty: 'Plant 10 trees this month' },
                { id: 2, family_id: 1, member_id: 1, duty: 'Attend community meeting' }
            ];
            setToStorage('duties', sampleDuties);
        }

        function getNextId(key) {
            const items = getFromStorage(key);
            return items.length > 0 ? Math.max(...items.map(i => i.id)) + 1 : 1;
        }

        function showToast(message, type = 'success') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast_' + Date.now();
            const icons = { success: 'check-circle', danger: 'exclamation-circle', warning: 'exclamation-triangle', info: 'info-circle' };
            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body"><i class="fas fa-${icons[type]} me-2"></i>${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
            toast.show();
            toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
        }

        function loadStats() {
            const families = getFromStorage('families');
            const members = getFromStorage('members');
            const duties = getFromStorage('duties');
            document.getElementById('totalFamilies').textContent = families.length;
            document.getElementById('totalMembers').textContent = members.length;
            document.getElementById('totalDuties').textContent = duties.length;
        }

        function loadFamilies() {
            const families = getFromStorage('families');
            const selects = [document.getElementById('familySelect'), document.getElementById('dutyFamilySelect'), document.getElementById('viewFamilySelect')];
            selects.forEach(select => {
                const isViewSelect = select.id === 'viewFamilySelect';
                select.innerHTML = isViewSelect ? '<option value="">All Families</option>' : '<option value="">Choose a family...</option>';
                families.forEach(family => {
                    const option = document.createElement('option');
                    option.value = family.id;
                    option.textContent = family.family_name;
                    select.appendChild(option);
                });
            });
        }

        function loadMembersForFamily(familyId, selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Entire Family</option>';
            if (!familyId) return;
            const members = getFromStorage('members').filter(m => m.family_id == familyId);
            members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.name} (${member.relationship})`;
                select.appendChild(option);
            });
        }

        function loadRecentMembers() {
            const container = document.getElementById('recentMembersContainer');
            container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Loading...</p></div>';
            const members = getFromStorage('members');
            if (members.length === 0) {
                container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-inbox fa-3x mb-3"></i><p>No members yet</p></div>';
                return;
            }
            const recent = members.slice(-5).reverse();
            container.innerHTML = recent.map(member => `
                <div class="member-card card mb-2 p-3" style="cursor: pointer;" onclick="showMemberDetails(${member.id})">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="avatar-circle"><i class="fas fa-user"></i></div>
                            <div>
                                <h6 class="mb-0">${member.name}</h6>
                                <small class="text-muted"><i class="fas fa-tag me-1"></i>${member.relationship}</small>
                            </div>
                        </div>
                        <span class="badge bg-primary badge-custom">View Details</span>
                    </div>
                </div>
            `).join('');
        }

        function loadDutiesList() {
            const container = document.getElementById('dutiesListContainer');
            container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Loading...</p></div>';
            const duties = getFromStorage('duties');
            const members = getFromStorage('members');
            if (duties.length === 0) {
                container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-inbox fa-3x mb-3"></i><p>No duties yet</p></div>';
                return;
            }
            container.innerHTML = duties.map(duty => {
                const assignee = duty.member_id ? members.find(m => m.id === duty.member_id)?.name || 'Unknown' : 'All Family';
                return `<div class="list-group-item">${duty.duty} - ${assignee}</div>`;
            }).join('');
        }

        function loadAllMembers() {
            const familyFilter = document.getElementById('viewFamilySelect').value;
            const container = document.getElementById('allMembersContainer');
            container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
            let members = getFromStorage('members');
            if (familyFilter) members = members.filter(m => m.family_id == familyFilter);
            if (members.length === 0) {
                container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-inbox fa-3x mb-3"></i><p>No members found</p></div>';
                return;
            }
            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr><th>Name</th><th>Relationship</th><th>Email</th><th>Phone</th><th>Actions</th></tr>
                        </thead>
                        <tbody>
                            ${members.map(member => `
                                <tr>
                                    <td><strong>${member.name}</strong></td>
                                    <td><span class="badge bg-info">${member.relationship}</span></td>
                                    <td><i class="fas fa-envelope me-1"></i>${member.email}</td>
                                    <td><i class="fas fa-phone me-1"></i>${member.phone}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="showMemberDetails(${member.id})"><i class="fas fa-eye"></i></button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteMember(${member.id})"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showMemberDetails(memberId) {
            currentMemberId = memberId;
            const member = getFromStorage('members').find(m => m.id === memberId);
            if (!member) return showToast('Member not found', 'danger');
            document.getElementById('memberDetailsContent').innerHTML = `
                <div class="text-center mb-3">
                    <div class="avatar-circle mx-auto mb-3"><i class="fas fa-user fa-2x"></i></div>
                    <h4>${member.name}</h4>
                    <span class="badge bg-primary badge-custom">${member.relationship}</span>
                </div>
                <hr>
                <div class="row">
                    <div class="col-6 mb-3"><strong><i class="fas fa-envelope me-2"></i>Email:</strong><p class="mb-0">${member.email}</p></div>
                    <div class="col-6 mb-3"><strong><i class="fas fa-phone me-2"></i>Phone:</strong><p class="mb-0">${member.phone}</p></div>
                </div>
            `;
            new bootstrap.Modal(document.getElementById('memberDetailsModal')).show();
        }

        function deleteMember(id) {
            if (!confirm('Are you sure? This cannot be undone.')) return;
            let members = getFromStorage('members').filter(m => m.id !== id);
            setToStorage('members', members);
            let duties = getFromStorage('duties').filter(d => d.member_id !== id);
            setToStorage('duties', duties);
            showToast('Member deleted', 'success');
            loadRecentMembers();
            loadAllMembers();
            loadDutiesList();
            loadStats();
            bootstrap.Modal.getInstance(document.getElementById('memberDetailsModal'))?.hide();
        }

        function validateForm(form) {
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return false;
            }
            if (form.id === 'memberForm') {
                const phone = form.phone.value;
                const name = form.name.value;
                if (!/^\+250\d{9}$/.test(phone)) {
                    showToast('Invalid phone format: +250 followed by 9 digits', 'danger');
                    return false;
                }
                if (!/^[A-Za-z\s]+$/.test(name)) {
                    showToast('Name must contain only letters and spaces', 'danger');
                    return false;
                }
            } else if (form.id === 'dutyForm') {
                if (form.duty.value.length < 10) {
                    showToast('Duty description must be at least 10 characters', 'danger');
                    return false;
                }
            } else if (form.id === 'familyForm') {
                if (!/^[A-Za-z\s]+$/.test(form.family_name.value)) {
                    showToast('Family name must contain only letters and spaces', 'danger');
                    return false;
                }
            }
            return true;
        }

        document.getElementById('familyForm').addEventListener('submit', e => {
            e.preventDefault();
            if (!validateForm(e.target)) return;
            const formData = new FormData(e.target);
            const families = getFromStorage('families');
            families.push({ id: getNextId('families'), family_name: formData.get('family_name') });
            setToStorage('families', families);
            showToast('Family registered!', 'success');
            e.target.reset();
            e.target.classList.remove('was-validated');
            loadFamilies();
            loadStats();
            bootstrap.Modal.getInstance(document.getElementById('familyModal')).hide();
        });

        document.getElementById('memberForm').addEventListener('submit', e => {
            e.preventDefault();
            if (!validateForm(e.target)) return;
            const formData = new FormData(e.target);
            const members = getFromStorage('members');
            members.push({
                id: getNextId('members'),
                family_id: parseInt(formData.get('family_id')),
                name: formData.get('name'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                relationship: formData.get('relationship')
            });
            setToStorage('members', members);
            showToast('Member added!', 'success');
            e.target.reset();
            e.target.classList.remove('was-validated');
            loadRecentMembers();
            loadStats();
            bootstrap.Modal.getInstance(document.getElementById('memberModal')).hide();
        });

        document.getElementById('dutyForm').addEventListener('submit', e => {
            e.preventDefault();
            if (!validateForm(e.target)) return;
            const formData = new FormData(e.target);
            const duties = getFromStorage('duties');
            duties.push({
                id: getNextId('duties'),
                family_id: parseInt(formData.get('family_id')),
                member_id: formData.get('member_id') ? parseInt(formData.get('member_id')) : null,
                duty: formData.get('duty')
            });
            setToStorage('duties', duties);
            showToast('Duty assigned!', 'success');
            e.target.reset();
            e.target.classList.remove('was-validated');
            loadDutiesList();
            loadStats();
            bootstrap.Modal.getInstance(document.getElementById('dutyModal')).hide();
        });

        document.getElementById('dutyFamilySelect').addEventListener('change', e => loadMembersForFamily(e.target.value, 'dutyMemberSelect'));
        document.getElementById('viewFamilySelect').addEventListener('change', loadAllMembers);
        document.getElementById('deleteMemberBtn').addEventListener('click', () => currentMemberId && deleteMember(currentMemberId));
        document.getElementById('viewModal').addEventListener('shown.bs.modal', loadAllMembers);

        document.addEventListener('DOMContentLoaded', () => {
            loadFamilies();
            loadRecentMembers();
            loadDutiesList();
            loadStats();
        });

        // Login
        if (localStorage.getItem('loggedIn') !== 'true') {
            window.location.href = 'login.html';
        }

        document.querySelector('.navbar .container-fluid').insertAdjacentHTML('beforeend', `
            <button class="btn btn-outline-light btn-sm ms-3" onclick="logout()">Logout</button>
        `);

        function logout() {
            localStorage.clear(); // or remove specific items
            window.location.href = 'login.html';
        }

        const username = localStorage.getItem('username');
        const role = localStorage.getItem('userRole');
        if (username) {
            document.querySelector('.navbar-brand').insertAdjacentHTML('afterend', `
                <span class="navbar-text mx-4 text-light fw-bold">Welcome, ${username} (${role || 'User'})</span>
            `);
        }
    </script>
</body>
</html>